<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html dir='ltr' lang='en-US' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <meta content='text/html; charset=utf-8' http-equiv='Content-type' />
    <title>Matt Sears | Ruby Blocks as Dynamic Callbacks</title>
    <meta content='Matt Sears, Matt, Sears' name='keywords' />
    <meta author='Matt Sears' />
    <link href='http://feeds.feedburner.com/mattsears' rel='alternate' title='Feed for mattsears' type='application/atom+xml' />
    <link href='/images/favicon.png' rel='shortcut icon' />
    <link href='/style.css' media='all' rel='stylesheet' type='text/css' />
    <!--[if IE 6]>
      <link rel="stylesheet" href="css/ie6.css" type="text/css" media="all" />
    <![endif]-->
    <script charset='utf-8' src='/javascripts/jquery-1.4.2.min.js' type='text/javascript'></script>
    <script charset='utf-8' src='/javascripts/cufon-yui.js' type='text/javascript'></script>
    <script charset='utf-8' src='/javascripts/titillium_400_mod2.font.js' type='text/javascript'></script>
    <script charset='utf-8' src='/javascripts/titillium_800_mod2.font.js' type='text/javascript'></script>
    <script charset='utf-8' src='/javascripts/cross-fade.js' type='text/javascript'></script>
    <script charset='utf-8' src='/javascripts/jquery.tipsy.js' type='text/javascript'></script>
    <script charset='utf-8' src='/javascripts/application.js' type='text/javascript'></script>
  </head>
  <body class='articles'>
    <div class='page-bg'>&nbsp;</div>
    <div id='header'>
      <div class='shell'>
        <div class='cl'>&nbsp;</div>
        <a href='/'>
          <h1 class='nocufon' id='logo'></h1>
        </a>
        <div class='right'>
          <div class='cl'>&nbsp;</div>
          <div id='navigation'>
            <ul>
              <li class='home-link'>
                <a href='/'>Home</a>
              </li>
              <li class='divider'>/</li>
              <li class='articles-link'>
                <a href='/articles'>Articles</a>
              </li>
              <li class='divider'>/</li>
              <li class='tumblr-link'>
                <a href='http://mattsears.tumblr.com'>Notebook</a>
              </li>
              <li class='divider'>/</li>
              <li class='about-link'>
                <a href='/about'>About</a>
              </li>
            </ul>
          </div>
          <div class='cl'>&nbsp;</div>
        </div>
        <div class='cl'>&nbsp;</div>
      </div>
    </div>
    <div id='main'>
      <div class='shell'>
          <div id='content'>
            <div id='content-top'></div>
            <div class='posts'>
              <div class='post rounded-top'>
                <div class='head'>
                  <h2>
                    <a href='/articles/2011/11/27/ruby-blocks-as-dynamic-callbacks'>
                      Ruby Blocks as Dynamic Callbacks
                    </a>
                    <span>
                      <a class='dsq-comment-count comment-link commentslink' href='http://www.mattsears.com/articles/2011/11/27/ruby-blocks-as-dynamic-callbacks#disqus_thread'></a>
                    </span>
                  </h2>
                  <div class='cl'>&nbsp;</div>
                </div>
                <div class='body'>
                  <p class='with-border'>
                    <p>Callbacks are a great technique for achieving simplicity and flexibility. Simply put,
                    a callback is a block of code passed as an argument to a method. In Ruby, code
                    blocks are everywhere and Ruby makes it trivial to pass a block of code to
                    methods. For example:</p><div class="highlight">
                    <pre><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>&#x000A;  <span class="n">callback</span> <span class="o">=</span> <span class="n">block</span>&#x000A;  <span class="n">callback</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>&#x000A;<span class="k">end</span>&#x000A;&#x000A;<span class="n">foo</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">}</span> <span class="c1"># =&gt; 25</span></pre>
                    </div><p>But what do we do when a method needs two blocks of code or more? Consider the
                    classic case where we want a method to execute a block of code if an action
                    succeeds or call different code if an action fails.</p><p>In this article, I will demonstrate how we can pass multiple blocks to a method and
                    with some metaprogramming, we can achieve a dynamic callback mechanism with just
                    a few lines of code.</p><p>Let's add a method called <code>callback</code> to the Proc class:</p><div class="highlight">
                    <pre><span class="k">class</span> <span class="nc">Proc</span>&#x000A;  <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>&#x000A;    <span class="nb">self</span> <span class="o">===</span> <span class="no">Class</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>&#x000A;      <span class="n">method_name</span> <span class="o">=</span> <span class="n">callable</span><span class="o">.</span><span class="n">to_sym</span>&#x000A;      <span class="n">define_method</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span> <span class="p">{</span> <span class="o">|&amp;</span><span class="n">block</span><span class="o">|</span> <span class="n">block</span><span class="o">.</span><span class="n">nil?</span> <span class="p">?</span> <span class="kp">true</span> <span class="p">:</span> <span class="n">block</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="p">}</span>&#x000A;      <span class="n">define_method</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">?"</span><span class="p">)</span> <span class="p">{</span> <span class="kp">true</span> <span class="p">}</span>&#x000A;      <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="kp">false</span><span class="p">;</span> <span class="k">end</span>&#x000A;    <span class="k">end</span><span class="o">.</span><span class="n">new</span>&#x000A;  <span class="k">end</span>&#x000A;<span class="k">end</span></pre>
                    </div><p>That's it! The above <code>Proc#callback</code> method simply yields an anonymous class
                    with methods defined to handle our callbacks. This allows for the capability of
                    creating and storing dynamic callbacks, which can later be looked up and
                    executed as needed.</p><p>Notice anything unusual? We're using the <code>===</code> operand to invoke the
                    block. <code>Proc#===</code> is an alias for <code>Proc.call</code>. Anything on the right side of
                    <code>===</code> acts as the proc's parameter. Normally, this is to allow a proc object to
                    be a target of a <code>when</code> clause in case statements, but we're using it as a super
                    simple way of invoking our anonymous class.</p><p>Let&rsquo;s try it with something useful. Let&rsquo;s say we&rsquo;re writing something which
                    needs to happen in an all-or-nothing, atomic fashion. Either the whole thing
                    works, or none of it does.  A simple case is tweeting:</p><div class="highlight">
                    <pre><span class="k">def</span> <span class="nf">tweet</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>&#x000A;  <span class="no">Twitter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>&#x000A;  <span class="n">block</span><span class="o">.</span><span class="n">callback</span> <span class="ss">:success</span>&#x000A;<span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>&#x000A;  <span class="n">block</span><span class="o">.</span><span class="n">callback</span> <span class="ss">:failure</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span>&#x000A;<span class="k">end</span></pre>
                    </div><p>The <code>tweet</code> method accepts a message string and &amp;block parameters. We call
                    <code>callback</code> on the block and give it a name. Any name will work :success, :error,
                    :fail!, whatever. In addition, we can pass arguments to the blocks (more on that
                    later). Now we can provide a status if the tweet was successful or not:</p><div class="highlight">
                    <pre><span class="n">tweet</span> <span class="s2">"Ruby methods with multiple blocks. #lolruby"</span> <span class="k">do</span> <span class="o">|</span><span class="n">on</span><span class="o">|</span>&#x000A;  <span class="n">on</span><span class="o">.</span><span class="n">success</span> <span class="k">do</span>&#x000A;    <span class="nb">puts</span> <span class="s2">"Tweet successful!"</span>&#x000A;  <span class="k">end</span>&#x000A;  <span class="n">on</span><span class="o">.</span><span class="n">failure</span> <span class="k">do</span> <span class="o">|</span><span class="n">status</span><span class="o">|</span>&#x000A;    <span class="nb">puts</span> <span class="s2">"Error: </span><span class="si">#{</span><span class="n">status</span><span class="si">}</span><span class="s2">"</span>&#x000A;  <span class="k">end</span>&#x000A;<span class="k">end</span></pre>
                    </div><p>The advantage here is that we define our own mini DSL. We don't need to worry
                    about passing too many or unexpected blocks. We could have easily said
                    <code>where.success</code> or <code>on.error</code> or <code>update.fail!</code>. Also note the <code>on.failure</code>
                    block includes a <code>status</code> parameter - this contains the exception message
                    captured in the <code>tweet</code> method above. So if Twitter was down for whatever
                    reason, the <code>on.failure</code> block would be invoked and printed 'Error: Twitter is
                    down or being upgraded'.</p><p>Bonus: In addition to wrapping code in blocks, our <code>Proc#callback</code> method
                    defines boolean style methods. So we could have call the tweet method like this
                    if we wanted to:</p><div class="highlight">
                    <pre><span class="n">tweet</span> <span class="s2">"Ruby methods with multiple blocks. #lolruby"</span> <span class="k">do</span> <span class="o">|</span><span class="n">update</span><span class="o">|</span>&#x000A;  <span class="nb">puts</span> <span class="s2">"Tweet successful!"</span> <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">success?</span>&#x000A;  <span class="nb">puts</span> <span class="s2">"Sorry, something went wrong."</span> <span class="k">if</span> <span class="n">update</span><span class="o">.</span><span class="n">failure?</span>&#x000A;<span class="k">end</span></pre>
                    </div><p>Put the <code>Proc#callback</code> method in a utility library and your code will look neat and tidy.</p><p>As always, I welcome your thoughts and feedback. Let me know what you think of
                    the techniques shown here, or share your own favorite code block tricks.</p>
                  </p>
                </div>
              </div>
              <div class='post-bottom'>
                <script type='text/javascript'>
                  //<![CDATA[
                    var disqus_shortname = 'mattsears'; // required: replace example with your forum shortname
                    var disqus_identifier = "/articles/2011/11/27/ruby-blocks-as-dynamic-callbacks/";
                    var disqus_url = "http://www.mattsears.com/articles/2011/11/27/ruby-blocks-as-dynamic-callbacks";
                  //]]>
                </script>
              </div>
              <div class='post-comments'>
                <br />
                <div id='disqus_thread'></div>
                <script type='text/javascript'>
                  //<![CDATA[
                    var disqus_developer = 1;
                  //]]>
                </script>
                <script type='text/javascript'>
                  //<![CDATA[
                    var disqus_identifier = "/articles/2011/11/27/ruby-blocks-as-dynamic-callbacks/";
                    var disqus_url = "http://www.mattsears.com/articles/2011/11/27/ruby-blocks-as-dynamic-callbacks";
                    // The following are highly recommended additional parameters. Remove the slashes in front to use.
                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                  //]]>
                </script>
                <noscript>
                  Please enable JavaScript to view the
                  <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a>
                </noscript>
              </div>
            </div>
          </div>
          <div id='sidebar'>
            <div class='get-in-touch'>
              <div class='me'>
                <img class='fade' src='/images/me.png' style='background: url(/images/me!.png)' />
              </div>
              <p>
                Hi. I'm Matt Sears, a web developer
                <span class='amp'>&</span>
                entrepreneur in Ohio. I run
                <a href='http://littlelines.com' rel='external'>Littlelines,</a>
                a distinguished web development and design firm.
              </p>
              <p>
                I use this blog to share my ideas and as a way to learn.
                Feel free to contact me via email or follow me on Twitter at
                <a href='https://twitter.com/mattsears' rel='external'>
                  @mattsears.
                </a>
              </p>
            </div>
            <div class='elsewhere'>
              <h4>Connect</h4>
              <ul>
                <li>
                  <a class='small-ico-external' href='https://twitter.com/mattsears' rel='external'>Twitter</a>
                </li>
                <li>
                  <a class='small-ico-external' href='http://www.facebook.com/mattsears.me' rel='external'>Facebook</a>
                </li>
                <li>
                  <a class='small-ico-external' href='http://www.linkedin.com/in/matthewsears' rel='external'>LinkedIn</a>
                </li>
                <li>
                  <a class='small-ico-external' href='http://github.com/mattsears' rel='external'>Github</a>
                </li>
                <li>
                  <a class='small-ico-external' href='https://plus.google.com/106286747861473847411' rel='external'>Google+</a>
                </li>
                <li>
                  <a class='small-ico-external' href='http://forrst.me/mattsears.me' rel='external'>Forrst</a>
                </li>
                <li>
                  <a class='small-ico-external' href='http://www.flickr.com/photos/matthewsears' rel='external'>Flickr</a>
                </li>
                <li class='last'>
                  <a class='small-ico-external' href='http://mattsears.tumblr.com' rel='external'>Tumblr</a>
                </li>
              </ul>
            </div>
            <div class='recent-posts'>
              <h4>Recent Posts</h4>
              <ul>
                <li>
                  <a href='/articles/2011/11/27/ruby-blocks-as-dynamic-callbacks'>Ruby Blocks as Dynamic Callbacks</a>
                </li>
                <li>
                  <a href='/articles/2011/11/16/nyan-cat-rspec-formatter'>Nyan Cat RSpec Formatter</a>
                </li>
                <li>
                  <a href='/articles/2011/10/20/gaga-key-value-store'>Gaga: A Git-Backed Key/Value Store</a>
                </li>
                <li>
                  <a href='/articles/2011/5/15/print-stamps-with-ruby'>Print Stamps With Ruby!</a>
                </li>
                <li>
                  <a href='/articles/2011/1/11/easy-multiple-account-management-for-heroku'>Easy Multiple Account Management for Heroku</a>
                </li>
              </ul>
            </div>
            <div class='categories'>
              <h4>Categories</h4>
              <ul>
                <li>
                  <a href='/articles/tags/ruby'>ruby</a>
                </li>
                <li>
                  <a href='/articles/tags/git'>git</a>
                </li>
                <li>
                  <a href='/articles/tags/rails'>rails</a>
                </li>
                <li>
                  <a href='/articles/tags/clojure'>clojure</a>
                </li>
                <li>
                  <a href='/articles/tags/code'>code</a>
                </li>
                <li>
                  <a href='/articles/tags/projects'>projects</a>
                </li>
                <li>
                  <a href='/articles/tags/sinatra'>sinatra</a>
                </li>
                <li>
                  <a href='/articles/tags/conference'>conference</a>
                </li>
                <li>
                  <a href='/articles/tags/capistrano'>capistrano</a>
                </li>
                <li>
                  <a href='/articles/tags/passenger'>passenger</a>
                </li>
                <li>
                  <a href='/articles/tags/littlelines'>littlelines</a>
                </li>
                <li>
                  <a href='/articles/tags/architecture'>architecture</a>
                </li>
                <li>
                  <a href='/articles/tags/news'>news</a>
                </li>
              </ul>
            </div>
            <div class='archives'>
              <h4>Archives</h4>
              <ul>
                <li>
                  <a href='/articles/archives/2011/11'>November 2011 (2)</a>
                </li>
                <li>
                  <a href='/articles/archives/2011/10'>October 2011 (1)</a>
                </li>
                <li>
                  <a href='/articles/archives/2011/05'>May 2011 (1)</a>
                </li>
                <li>
                  <a href='/articles/archives/2011/01'>January 2011 (1)</a>
                </li>
                <li>
                  <a href='/articles/archives/2009/10'>October 2009 (1)</a>
                </li>
                <li>
                  <a href='/articles/archives/2009/06'>June 2009 (1)</a>
                </li>
                <li>
                  <a href='/articles/archives/2009/04'>April 2009 (1)</a>
                </li>
                <li>
                  <a href='/articles/archives/2008/12'>December 2008 (1)</a>
                </li>
                <li>
                  <a href='/articles/archives/2008/11'>November 2008 (2)</a>
                </li>
                <li>
                  <a href='/articles/archives/2008/08'>August 2008 (1)</a>
                </li>
                <li>
                  <a href='/articles/archives/2008/07'>July 2008 (5)</a>
                </li>
                <li>
                  <a href='/articles/archives/2008/01'>January 2008 (1)</a>
                </li>
              </ul>
            </div>
          </div>
          <div class='cl'>&nbsp;</div>
        </div>
    </div>
    <div id='footer'>
      <div class='shell'>
        <div class='left'>
          <p>&copy; Copyright 2011 Matt Sears. All Rights Reserved.</p>
        </div>
        <p class='footer-navigation'>
          Powered by
          <a href='http://mattsears.github.com/aerial' rel='external'>Aerial</a>
          on
          <a href='http://heroku.com' rel='external'>Heroku</a>
        </p>
        <div class='cl'>&nbsp;</div>
      </div>
    </div>
    <script type='text/javascript'>
      //<![CDATA[
        Cufon.now();
        //
        (function () {
          var disqus_shortname = 'mattsears';
          var s = document.createElement('script'); s.async = true;
          s.type = 'text/javascript';
          s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
        //
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-2776418-3']);
        _gaq.push(['_trackPageview']);
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      //]]>
    </script>
  </body>
</html>
